# TODO Items

Need to add functionality where we can control access to each stream. Want to add a number of minor modifications to the
RTSPtoWeb project to provide the following additional services:

- Collect details on the number of clients, bandwidth, and streams in use 
- The ability to control access to particular streams (token based access)
- The ability to disconnect users (if the server is busy or if they've been watching too long.)

This can be accomplished by adding an (optional) clientID (CID) to each video stream request.

The server will check the CID and either allow or deny access. 

For public or open streams, this could be blank and generated by the server.

CID creation can be done via API, or with custom code, or allow all viewers.

Where the streams are private or need to be controlled, a back end application can generate a CID that can be used like
a token to gain access to a stream.

In html/js, an ajax->get Client ID, then request a stream using the token. 

The server would check the CID and make sure the user was authorized to see the stream. If no stream authorization used,
a random CID would be generated
 
## ClientInfo structure

The server would map a data structure to the CID to hold information about the stream:

````ClientInfo {
cid string
stream string //stream they are watching
channel string 
start video timestamp
last_packet sent timestamp
bytes_sent int
Mode enum { HLS,WebRTC, XXX} 
disconnect disconnect 
}
````

A map[cid][ClientInfo] would be kept by the server in the ClientInfoManager.

## ClientInfoManager

This class manages CIDs and information about each streaming client (viewer)
The main data structure is a map whose key is the CID, and whose value is a ClientInfo record.

map[cid:string][info:ClientInfo].

````
// return a ClientInfo record for a streaming client. 
createOrCheckCID(cid, stream, channel) (ClientInfo,err) // return cid structure, or error if unauthorized. 
addCID(cid, stream, channel) add new ClientInfo to map[cid][info]   // called by API, typically
removeCID(cid) remove from map[cid]     // called by API or when stream is finished.
removeStaleCIDs() // remove old cids that haven't updated last_packet in N seconds.
getClients() (map[cid][ClientInfo] // return a map of ClientInfo records 
requireAuthorization() (boolean) // return true if a valid CID is required, saved in prefs or startup argument.
logBytes(cid, bytes) //
isDisconnected(cid) (boolean)   // returns true if not in map or disconnected flag is true. 
````

This class needs to dispose of the ClientInfo when not used by the stream and/or map. (Not sure best practice for go on shared objects.)

When a stream is finished (error, etc.) they can dispose of the ClientInfo record by calling removeCID.

Periodically the map would be cleared of stale clients. 

An (admin) API would allow listing, adding, deleting and getting information about clients by client ID.

## API Changes

Some basic API need to be added. 
````
/clients // get list of clients viewing stream 
/client/info/cid // return details about a client ClientInfo as json.
/client/add/cid?stream=xyz&channel=0 
/client/delete/cid // disconnect a client
/stream/stream_name/channel/chan_num/webrtc?uuid=" + uuid + '&channel=' + channel + "&cid=1234";
````

These calls would need to check the internal user/password. 

## HTML changes

I believe the only changes to the basic html will be to add a cid parameter to the /stream calls. Graceful handling of "
unauthorized" errors might be needed.

## Questions for developer

What ports are used by the server (webrtc ports, ice/stun, etc.)
Need to list all ports used so that they can be exposed in Dockerfile.

What is the existing token system (CheckTokenAccess) Need to understand if it is the same as my requirement.

How to automatically determine which streaming type to use for each browser?
